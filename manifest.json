{
  "$schema": "https://raw.githubusercontent.com/navidrome/navidrome/refs/heads/master/plugins/manifest-schema.json",
  "$id": "navidrome://plugins/manifest/listenbrainz-daily-playlist",
  "name": "listenbrainz-daily-playlist",
  "author": "Kendall Garner",
  "version": "4.0.0",
  "description": "Import playlists from ListenBrainz",
  "website": "https://github.com/kgarner7/navidrome-listenbrainz-daily-playlist",
  "permissions": {
    "http": {
      "reason": "To fetch metadata from listenBrainz",
      "requiredHosts": ["api.listenbrainz.org"]
    },
    "scheduler": {
      "reason": "To schedule periodic daily playlist sync"
    },
    "subsonicapi": {
      "reason": "Requires subsonic API to search for songs and create/update playlists on behalf of users"
    },
    "users": {
      "reason": "Requires user access for subsonic API"
    }
  },
  "config": {
    "schema": {
      "type": "object",
      "properties": {
        "users": {
          "type": "array",
          "title": "User configurations",
          "minItems": 1,
          "description": "ListenBrainz configurations for each user",
          "items": {
            "type": "object",
            "properties": {
              "username": {
                "type": "string",
                "title": "Navidrome Username",
                "description": "The Navidrome username to associate with this ListenBrainz username",
                "minLength": 1
              },
              "lbzUsername": {
                "type": "string",
                "title": "ListenBrainz username",
                "description": "The ListenBrainz username to associate with this user",
                "minLength": 1
              },
              "lbzToken": {
                "type": "string",
                "title": "ListenBrainz token",
                "description": "The ListenBrainz token to use for this user (optional)",
                "minLength": 1
              },
              "generatePlaylist": {
                "type": "boolean",
                "title": "Generate playlist",
                "minLength": 1
              },
              "generatedPlaylist": {
                "default": "Generated Daily Jams",
                "type": "string",
                "title": "Generated playlist name",
                "minLength": 1
              },
              "generatedPlaylistTrackAge": {
                "default": 60,
                "type": "integer",
                "title": "Exclude tracks played in the last X days",
                "description": "Set 0 to include all recommendations",
                "minimum": 0
              },
              "generatedPlaylistArtistLimit": {
                "default": 2,
                "type": "integer",
                "title": "Maximum number of tracks per artist",
                "description": "Set 0 to have no limit per artist",
                "minimum": 0
              },
              "sources": {
                "type": "array",
                "title": "Playlists to import",
                "default": [
                  {
                    "sourcePatch": "daily-jams", "playlistName": "ListenBrainz Daily Jams"
                  },
                  {
                    "sourcePatch": "weekly-jams", "playlistName": "ListenBrainz Weekly Jams"
                  }
                ],
                "items": {
                  "type": "object",
                  "properties": {
                    "sourcePatch": {
                      "type": "string",
                      "title": "Source",
                      "description": "The source as declared by ListenBrainz. This includes: weekly-exploration, weekly-jams, daily-jams",
                      "minLength": 1
                    },
                    "playlistName": {
                      "type": "string",
                      "title": "Playlist name to be imported",
                      "description": "The name of the playlist as it will be created/updated for the user. This playlist will be overridden",
                      "minLength": 1
                    }
                  },
                  "required": ["playlistName", "sourcePatch"]
                }
              },
              "ratings": {
                "type": "array",
                "minItems": 1,
                "title": "Ratings",
                "description": "Select multiple ratings",
                "uniqueItems": true,
                "default": ["0", "1", "2", "3", "4", "5"],
                "items": {
                  "oneOf": [
                    { "const": "0", "title": "No rating" },
                    { "const": "1", "title": "1 star" },
                    { "const": "2", "title": "2 stars" },
                    { "const": "3", "title": "3 stars" },
                    { "const": "4", "title": "4 stars" },
                    { "const": "5", "title": "5 stars" }
                  ]
                }
              }
            },
            "anyOf": [
              {
                "properties": {
                  "generatePlaylist": { "const": false },
                  "sources": { "minItems": 1 }
                },
                "required": ["lbzUsername", "ratings", "sources", "username"]
              },
              {
                "properties": {
                  "generatePlaylist": { "const": true }
                },
                "required": ["generatedPlaylist", "generatedPlaylistArtistLimit", "generatedPlaylistTrackAge", "lbzUsername", "ratings", "username"]
              }
            ]
          }
        },
        "schedule": {
          "type": "integer",
          "title": "Hour to fetch playlists (24-hour format)",
          "description": "NOTE: To be kind to LBZ servers, this fetch happens at a random interval between this time and one hour later.",
          "minimum": 0,
          "maximum": 24,
          "default": 8
        },
        "checkOnStartup": {
          "type": "boolean",
          "title": "Check for out of date playlists on plugin start",
          "default": true
        },
        "fallbackCount": {
          "type": "integer",
          "title": "Fallback search count",
          "description": "Normally, this plugin tries to match tracks by MusicBrainz ID. When that fails, this count specifies the number of tracks to try to match by artist/title",
          "default": 15,
          "minimum": 1,
          "maximum": 500
        }
      },
      "required": ["fallbackCount", "schedule", "users"]
    },
    "uiSchema": {
      "type": "VerticalLayout",
      "elements": [
        {
          "type": "Control",
          "scope": "#/properties/users",
          "options": {
            "elementLabelProp": "username",
            "detail": {
              "type": "VerticalLayout",
              "elements": [
                {
                  "type": "Control",
                  "scope": "#/properties/username"
                },
                {
                  "type": "Control",
                  "scope": "#/properties/lbzUsername"
                },
                {
                  "type": "Control",
                  "scope": "#/properties/lbzToken"
                },
                {
                  "type": "Label",
                  "text": "Generate playlist locally from ListenBrainz recommendations rather than fetching from ListenBrainz. Caution: this is experimental, and takes time (upwards of 5 seconds) per playlist"
                },
                {
                  "type": "Control",
                  "scope": "#/properties/generatePlaylist"
                },
                {
                  "type": "Control",
                  "scope": "#/properties/generatedPlaylist",
                  "rule": {
                    "effect": "SHOW",
                    "condition": {
                      "scope": "#/properties/generatePlaylist",
                      "schema": {
                        "const": true
                      }
                    }
                  }
                },
                {
                  "type": "Control",
                  "scope": "#/properties/generatedPlaylistTrackAge",
                  "rule": {
                    "effect": "SHOW",
                    "condition": {
                      "scope": "#/properties/generatePlaylist",
                      "schema": {
                        "const": true
                      }
                    }
                  }
                },
                {
                  "type": "Control",
                  "scope": "#/properties/generatedPlaylistArtistLimit",
                  "rule": {
                    "effect": "SHOW",
                    "condition": {
                      "scope": "#/properties/generatePlaylist",
                      "schema": {
                        "const": true
                      }
                    }
                  }
                },
                {
                  "type": "Control",
                  "scope": "#/properties/sources",
                  "options": {
                    "elementLabelProp": "sourcePatch",
                    "detail": {
                      "type": "HorizontalLayout",
                      "elements": [
                        {
                          "type": "Control",
                          "scope": "#/properties/sourcePatch"
                        },
                        {
                          "type": "Control",
                          "scope": "#/properties/playlistName"
                        }
                      ]
                    }
                  }
                },
                {
                  "type": "Label",
                  "text": "Include tracks with this rating. Tracks with a rating not selected will be excluded from matching"
                },
                {
                  "type": "Control",
                  "scope": "#/properties/ratings"
                }
              ]
            }
          }
        },
        {
          "type": "HorizontalLayout",
            "elements": [
            {
              "type": "Control",
              "scope": "#/properties/schedule"
            },        {
              "type": "Control",
              "scope": "#/properties/fallbackCount"
            }
          ]
        },
        {
          "type": "Control",
          "scope": "#/properties/checkOnStartup"
        }
      ]
    }
  }
}